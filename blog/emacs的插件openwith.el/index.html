<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Emacs的插件openwith.el - 一个人的狂欢</title>
    <meta charset="utf-8" />
    <meta name="author" content="纪秀峰" />
    <meta name="description" content="Emacs的插件open-with.el" />
    <meta name="keywords" content="emacs open with " />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">一个人的狂欢</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="http://github.com/jixiuf">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="jixiuf.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>Emacs的插件openwith.el</h1>
<p>
默认情况下，当你用Emacs中的`C-xC-f' 打开文件时，不论它是什么类型的文件，都会<br  />
使用emacs打开。但有些时候希望遇到avi 文件时使用外部播放器打开，而非emacs所以<br  />
emacswiki上有人提供了openwith.el 插件。用来实现对于不同后缀的文件可以调用不<br  />
同的命令来打开.因为我用Linux及Windows两个系统所以配置文件分成了两套。<br  />
在Windows 上，同时用到了w32-browser.el w32-shell-execute.el等插件。<br  />
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">;;  openwith ,外部程序

;;直接用正常的方式打开相应的文件,openwith会自动做处理
;;`C-xC-f'即可
(when (eq system-type 'windows-nt)
  (require'w32-shell-execute)
  )
(require 'openwith)
(openwith-mode t)
(when (eq system-type 'gnu/linux)
  (setq openwith-associations
        '(("\\.pdf$" "acroread" (file)) ("\\.mp3$" "mplayer" (file) )
          ("\\.mov\\|\\.RM$\\|\\.RMVB$\\|\\.avi$\\|\\.AVI$\\|\\.flv$\\|\\.mp4\\|\\.mkv$\\|\\.rmvb$" "mplayer" (file) )
;;          ("\\.jpe?g$\\|\\.png$\\|\\.bmp\\|\\.gif$" "gpicview" (file))
          ("\\.CHM$\\|\\.chm$" "chmsee"  (file) )
          )
        )
  )
(when (eq system-type 'windows-nt)
  ;;windows 上使用w32-shell-execute 调用系统的相应程序打开
  (setq openwith-associations
        '(("\\.pdf$" "open" (file)) ("\\.mp3$" "open" (file) )
          ("\\.mov\\|\\.RM$\\|\\.RMVB$\\|\\.avi$\\|\\.AVI$\\|\\.flv$\\|\\.mp4\\|\\.mkv$\\|\\.rmvb$" "open" (file) )
          ("\\.jpe?g$\\|\\.png$\\|\\.bmp\\|\\.gif$" "open" (file))
          ("\\.CHM$\\|\\.chm$" "open"  (file) )
          )
        )
  )

;;默认情况下，return 即可以用`open-with'对特定后缀的文件使用相应的程序或
;;emacs mode打开，但有时候想提供第二种打开的方式 。比如默认对于html文件，我
;;会用emacs中的nxml-mode打开，但有时也想在firefox中浏览它，于是return 使用
;;nxml-mode，而C-RET则使用firefox进行打开
;;注意，我这里对html做了特殊处理，当打开html时，焦点自动切换到firefox上。使用了
;; Awesome 窗口管理器的特性。所以未必适合你，仅做参考。
(defun open-with-C-RET-on-linux()
  "in dired mode ,`C-RET' open file with ..."
  (interactive)
  (let ((file-name (dired-get-filename))
        (openwith-associations
        '(("\\.pdf$" "acroread" (file)) ("\\.mp3$" "mplayer" (file) )
          ("\\.RM$\\|\\.RMVB$\\|\\.avi$\\|\\.AVI$\\|\\.flv$\\|\\.mp4\\|\\.mkv$\\|\\.rmvb$" "mplayer" (file) )
          ("\\.jpe?g$\\|\\.png$\\|\\.bmp\\|\\.gif$" "gpicview" (file))
          ("\\.CHM$\\|\\.chm$" "chmsee"  (file) ))))
    (if (string-match "\\.html?$" file-name)
          (if (&gt; (string-to-number (shell-command-to-string "pgrep firefox | wc -l")) 0)
              (progn
                (start-process-shell-command "firefox" nil (format "echo ' show_matched_client({class=\"Firefox\" ,instance=\"Navigator\"},\"www\",\"/usr/bin/firefox %s  \" ,nil)' |awesome-client " file-name))
                (start-process "firefox-file" nil "firefox" file-name))
            (start-process-shell-command "firefox" nil (format "echo ' show_matched_client({class=\"Firefox\" ,instance=\"Navigator\"},\"www\",\"/usr/bin/firefox %s  \" ,nil)' |awesome-client " file-name))
            )
      (dired-find-file)
      )
    )
  )
(when (equal system-type 'gnu/linux)
  (eval-after-load 'dired
  '(define-key dired-mode-map [(control return)] 'open-with-C-RET-on-linux)))

;; 使用外部 文件管理器 打开选中文件所在文件夹
(when (eq system-type 'windows-nt)
  ;;on windows
  ;;  C-RET  用系统默认程序打开选中文件
  ;; M-RET  open Windows Explorer
  ;; ^ 我改成了u ,可以列出根盘符
  ;;
  (require 'w32-browser)
  ;; (define-key diredp-w32-drives-mode-map "n" 'next-line)
  ;; (define-key diredp-w32-drives-mode-map "p" 'previous-line)

  ;;C-M-&lt;RET&gt; 用资源管理器打开当前文件所处目录
  (defun explorer-open()
"用windows 上的explorer.exe打开此文件夹."
    (interactive)
    (if (equal major-mode 'dired-mode)
        (w32explore (expand-file-name (dired-get-filename)))
      (w32explore (expand-file-name (buffer-file-name)))
       )
    )
  (eval-after-load 'dired
    '(define-key dired-mode-map (quote [C-M-return]) 'explorer-open))
  (global-set-key (quote [C-M-return]) 'explorer-open)
;;  (lambda () (interactive ) (w32explore (expand-file-name default-directory)))
  )

;; linux `C-M-RET' 用pcmanfm文件管理器打开当前目录
(when (eq system-type 'gnu/linux)
  (defun open-directory-with-pcmanfm()
    (interactive)
    (start-process "pcmanfm"  nil "pcmanfm" (expand-file-name  default-directory)))
  (eval-after-load 'dired
    '(define-key dired-mode-map (quote [C-M-return]) 'open-directory-with-pcmanfm))
  (global-set-key (quote [C-M-return]) (quote open-directory-with-pcmanfm))
    )

(provide 'joseph-openwith)
</pre>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2011-07-08</span>
        <span title="last modification date" class="post-info">2016-01-14</span>
        <span title="tags" class="post-info"><a href="/tags/emacs/">Emacs</a></span>
        <span title="author" class="post-info">纪秀峰</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/emacs的插件openwith.el/";
          var disqus_url = "http://jixiuf.github.io/blog/emacs的插件openwith.el/";
          var disqus_shortname = 'jixiuf';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'jixiuf'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x (<a href="http://orgmode.org">Org mode</a> 8.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:jixiuf &lt;at&gt; gmail &lt;dot&gt; com">纪秀峰</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
