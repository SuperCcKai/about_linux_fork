<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>go语言一些开源的package拾遗 - 拾遗笔记</title>
    <meta charset="utf-8" />
    <meta name="author" content="纪秀峰" />
    <meta name="description" content="go语言一些开源的package拾遗" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->
  </head>
  <body class="container">
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ji -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-6633117582073327"
     data-ad-slot="1629980291"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

    
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">拾遗笔记</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="http://github.com/jixiuf">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="jixiuf.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>go语言一些开源的package拾遗</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1d22e7b">解析命令行参数的工具 gopkg.in/alecthomas/kingpin.v2</a></li>
<li><a href="#org9b8e98d">日志相关</a>
<ul>
<li><a href="#orgc41bc4c">github.com/cihub/seelog</a></li>
<li><a href="#org6c88814">github.com/op/go-logging</a></li>
</ul>
</li>
<li><a href="#org96deb70">读取配置文件 相关(json ,yaml,环境变量,etcd,命令行参数)</a></li>
<li><a href="#org866b694">github.com/dgryski/go-jump</a></li>
<li><a href="#orga944ee3">github.com/pquerna/ffjson</a></li>
<li><a href="#org5372c56">github.com/tools/godep</a></li>
<li><a href="#org29da561">github.com/gogo/protobuf/proto</a></li>
<li><a href="#orgd623bd7">github.com/stretchr/testify/assert</a></li>
<li><a href="#org6de1e82">leveldb 的hashmap cache与LRU 实现可以参考使用</a></li>
</ul>
</div>
</div>
<p>
在看一些golang 的开源项目的时候  ，看到他们用到的一些第三方库，感觉还不错<br />
记下来以备后用,看多少加多少<br />
最近在看<a href="https://github.com/hyperledger/fabric">https://github.com/hyperledger/fabric</a><br />
</p>
<div id="outline-container-org1d22e7b" class="outline-2">
<h2 id="org1d22e7b">解析命令行参数的工具 gopkg.in/alecthomas/kingpin.v2</h2>
<div class="outline-text-2" id="text-org1d22e7b">
<p>
轻松实现以下格式的命令行参数<br />
</p>
<blockquote>
<p>
usage: main [&lt;flags&gt;] &lt;command&gt; [&lt;args&gt; &#x2026;]<br />
Flags:<br />
    &#x2013;help     Show context-sensitive help (also try &#x2013;help-long and &#x2013;help-man).<br />
-d, &#x2013;dir="."  directory of data<br />
Commands:<br />
help [&lt;command&gt;&#x2026;]<br />
    Show help.<br />
accountlist [&lt;n&gt;]<br />
    get all account List.<br />
short<br />
    get short info about our chainblock system.<br />
account &lt;name&gt;<br />
    get account info.<br />
blocklist<br />
    get all blocklist.<br />
block &lt;name&gt;<br />
    get block info.<br />
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-go">var (
    dir              = kingpin.Flag("dir", "directory of data").Short('d').Default(".").String()
    accountListCMD   = kingpin.Command("accountlist", "get all account List.")
    accountListLimit = accountListCMD.Arg("n", "limit account count").Int()
    shortCMD         = kingpin.Command("short", "get short info about our chainblock system.")
    accountCMD       = kingpin.Command("account", "get account info.")
    accountName      = accountCMD.Arg("name", "account name").Required().String()
    blockListCMD     = kingpin.Command("blocklist", "get all blocklist.")
    blockCMD         = kingpin.Command("block", "get  block info.")
    blockName        = blockCMD.Arg("name", "block name").Required().String()
)

func main() {
    kingpin.Parse()
    switch kingpin.MustParse(kingpin.Parse(), nil) {
    // Register user
    case shortCMD.FullCommand():
	printChain(*dir)
	return
    case accountListCMD.FullCommand():
	printAccountList(*dir, *accountListLimit)
	return
    case blockListCMD.FullCommand():
	printBlockList(*dir)
	return
    case blockCMD.FullCommand():
	if blockName == nil || *blockName == "" {
	    fmt.Printf("please give an account name like this:%s %s %s\n", os.Args[0], os.Args[1], "block{blockid}")
	    return
	}
	printBlock(*dir, *blockName)
	return

    case accountCMD.FullCommand():
	if accountName == nil || *accountName == "" {
	    fmt.Printf("please give an account name like this:%s %s %s\n", os.Args[0], os.Args[1], "account{accountid}")
	    return
	}
	printAccount(*dir, *accountName)
	return
    }
</pre>
</div>
</div>
</div>
<div id="outline-container-org9b8e98d" class="outline-2">
<h2 id="org9b8e98d">日志相关</h2>
<div class="outline-text-2" id="text-org9b8e98d">
</div><div id="outline-container-orgc41bc4c" class="outline-3">
<h3 id="orgc41bc4c">github.com/cihub/seelog</h3>
</div>
<div id="outline-container-org6c88814" class="outline-3">
<h3 id="org6c88814">github.com/op/go-logging</h3>
<div class="outline-text-3" id="text-org6c88814">
<p>
可以支持多种backend ,包括seelog 、文件等<br />
可以实现按模块定制日志输出级别（通过正则匹配package名实现）<br />
使用示例 github.com/hyperledger/fabric/common/flogging/logging.go<br />
</p>
</div>
</div>
</div>
<div id="outline-container-org96deb70" class="outline-2">
<h2 id="org96deb70">读取配置文件 相关(json ,yaml,环境变量,etcd,命令行参数)</h2>
<div class="outline-text-2" id="text-org96deb70">
<p>
github.com/spf13/viper<br />
可以设定默认值，以各种方式读取配置，各个配置可以相互覆盖,甚至可以通过e,tcd、Consul等方式进行读取<br />
也自以可选的进行加密<br />
</p>
</div>
</div>

<div id="outline-container-org866b694" class="outline-2">
<h2 id="org866b694">github.com/dgryski/go-jump</h2>
<div class="outline-text-2" id="text-org866b694">
<p>
golang 使用memcached 集群时有用到一致性哈希算法，这是一种实现<br />
纯计算 内在占用少<br />
</p>
</div>
</div>
<div id="outline-container-orga944ee3" class="outline-2">
<h2 id="orga944ee3">github.com/pquerna/ffjson</h2>
<div class="outline-text-2" id="text-orga944ee3">
<p>
json decode encode 加速<br />
</p>
</div>
</div>
<div id="outline-container-org5372c56" class="outline-2">
<h2 id="org5372c56">github.com/tools/godep</h2>
<div class="outline-text-2" id="text-org5372c56">
<p>
go 包版本管理工具,<br />
</p>
</div>
</div>
<div id="outline-container-org29da561" class="outline-2">
<h2 id="org29da561">github.com/gogo/protobuf/proto</h2>
<div class="outline-text-2" id="text-org29da561">
<p>
protobuf decode encode 加速<br />
可以实现为每条协议 生成 Marshaler UnMarshaler Size 等函数<br />
生成减少一次内在copy ,并且序列化反序列化的代码在编译期就生成 ，速度提升<br />
</p>
<div class="org-src-container">
<pre class="src src-makefile"> <span style="color: #FF6400;">default</span>:
       @mkdir -p ../pb/
       @awk -v <span style="color: #ffa07a;">"n=line-number"</span>\
-v <span style="color: #ffa07a;">'line1=import "github.com/gogo/protobuf/gogoproto/gogo.proto"; '</span>\
-v <span style="color: #ffa07a;">'line2=option (gogoproto.marshaler_all) = true;'</span>\
-v <span style="color: #ffa07a;">'line3=option (gogoproto.sizer_all) = true;'</span>\
-v <span style="color: #ffa07a;">'line4=option (gogoproto.unmarshaler_all) = true;'</span>\
<span style="color: #ffa07a;">'(NR==2) { print line1;print line2;print line3;print line4 } 1'</span>  base.proto&gt;base2.proto
       protoc --proto_path=$$GOPATH/src/github.com/gogo/protobuf/protobuf:$$GOPATH/src/:. --gogo_out=.  base2.proto
       @mv base2.pb.go ../pb/base.pb.go
       @rm -f base2.proto
       cp -f base.proto ../pb/base_bak.proto
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd623bd7" class="outline-2">
<h2 id="orgd623bd7">github.com/stretchr/testify/assert</h2>
<div class="outline-text-2" id="text-orgd623bd7">
<p>
写测试用的工具 demo:<br />
</p>
<div class="org-src-container">
<pre class="src src-go">assert.True(t, true, "should be true")
</pre>
</div>
</div>
</div>
<div id="outline-container-org6de1e82" class="outline-2">
<h2 id="org6de1e82">leveldb 的hashmap cache与LRU 实现可以参考使用</h2>
<div class="outline-text-2" id="text-org6de1e82">
<p>
<a href="https://github.com/syndtr/goleveldb/blob/master/leveldb/cache/cache.go">https://github.com/syndtr/goleveldb/blob/master/leveldb/cache/cache.go</a><br />
目前似乎key 只支持uint64,不支持string<br />
支持namespace,即一个 namespace 和key 两个参数才惟一确定一条数据<br />
hash 算法全用 murmur<br />
hash 算法将namespace与key 与seed 算出一个hash值（uint32）,<br />
然后根据hash值的低位4字节 分配到一个桶内（bucket）,后期随着桶内元素的增加，会增加桶的数量<br />
重新进行hash,<br />
</p>

<div class="org-src-container">
<pre class="src src-go">    type mNode struct {
	buckets         []unsafe.Pointer // []*mBucket n个桶桶
	mask            uint32
	pred            unsafe.Pointer // *mNode
	resizeInProgess int32

	overflow        int32
	growThreshold   int32
	shrinkThreshold int32
    }
    type mBucket struct {
	mu     sync.Mutex
	node   []*Node
	frozen bool
    }
// Node is a 'cache node'.
type Node struct {
    r *Cache

    hash    uint32
    ns, key uint64

    mu    sync.Mutex
    size  int
    value Value					// 真正存数据

    ref   int32
    onDel []func()

    CacheData unsafe.Pointer
}
</pre>
</div>
<p>
demo<br />
</p>
<div class="org-src-container">
<pre class="src src-go">c := cache.NewCache(nil)
h := c.Get(1, 11, func() (int, cache.Value) { return 5, "hello" }) // namespace=1,key==11
fmt.Println(h.Value().(string))
h.Release()						// 用完就得release()
h = c.Get(1, 11, nil)
fmt.Println(h.Value().(string))
h.Release()						// 用完就得release()
</pre>
</div>
<div class="org-src-container">
<pre class="src src-go">var c *cache.Cache
c = cache.NewCache(cache.NewLRU(20)) // 这种情况支持lru的hash ,当占用内存达到20时，将会采用lru算法清除最久没使用的数据
for i := 0; i &lt; 1000; i++ {
	c.Get(1, uint64(i), func() (int, cache.Value) { return 4, "world" + strconv.Itoa(i) }).Release()
}
</pre>
</div>
<p>
如果不需要namespace ,即所有的key在同一个namespace下，<br />
则以用NamespaceGetter包装一下,以后Get 只需要 传key 不需要传namespace<br />
</p>
<div class="org-src-container">
<pre class="src src-go">    var c *cache.Cache
    c = cache.NewCache(cache.NewLRU(20)) // 这种情况支持lru的hash ,当占用内存达到20时，将会采用lru算法清除最久没使用的数据
geter:=cache.NamespaceGetter{Cache: c, NS: 0}
geter.Get(11, func() (int, cache.Value) { return 5, "hello" }).Release() // namespace=1,key==11
geter.Get(11).Release()

</pre>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2017-08-21</span>
        <span title="last modification date" class="post-info">2017-08-22</span>
        <span title="tags" class="post-info">N/A</span>
        <span title="author" class="post-info">纪秀峰</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/go_package.html";
          var disqus_url = "http://jixiuf.github.io/blog/go_package.html";
          var disqus_shortname = 'jixiuf';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'jixiuf'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:jixiuf &lt;at&gt; qq &lt;dot&gt; com">纪秀峰</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
